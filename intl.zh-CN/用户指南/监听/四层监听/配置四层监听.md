# 配置四层监听 {#concept_vsd_vpn_vdb .concept}

负载均衡支持创建四层TCP和UDP协议监听。

## 四层监听概述 {#section_tzl_ms5_vdb .section}

-   TCP协议

    TCP是面向连接的协议，在正式收发数据前，必须和对方建立可靠的连接。TCP协议适用于注重可靠性，对数据准确性要求高，速度可以相对较慢的场景，如文件传输、发送或接收邮件、远程登录和无特殊要求的Web应用。

-   UDP协议

    UDP是面向非连接的协议，在数据发送前不与对方进行三次握手，直接进行数据包发送，不提供差错恢复和数据重传，可靠性相对低但数据传输快。UDP协议多用于关注实时性而相对不注重可靠性的场景，如视频聊天、金融实时行情推送等。

    UDP协议监听有如下限制：

    -   每个监听最大连接数限制：100,000。
    -   暂不支持分片包。
    -   经典网络负载均衡实例的UDP监听暂不支持查看源地址。
    -   在以下两种情况下，UDP协议监听配置需要五分钟才能生效：
        -   移除后端服务器。
        -   健康检查检测到异常后，将后端服务器的权重设置为0。

## 四层监听配置 {#section_ats_xq5_vdb .section}

|监听配置|说明|
|:---|:-|
|**前端协议 \[端口\]**|用来接收请求并向后端服务器进行请求转发的前端协议和端口。配置四层监听，协议选择TCP或UDP，端口为1-65535。

**说明：** 在同一个负载均衡实例内，前端端口不可重复。

|
|**后端协议 \[端口\]**|后端服务器（ECS实例）开放用来接收请求的后端端口。后端的协议类型和前端相同，端口为1-65535。

**说明：** 在同一个负载均衡实例内，后端端口可重复。

|
|**带宽峰值**|对于按带宽计费的负载均衡实例，您可以针对不同监听设定不同的带宽峰值来限定监听的流量。实例下所有监听的带宽峰值总和不能超过该实例的带宽。当不限制监听带宽时，各监听共享实例的总带宽。更多详细信息，参考[共享实例带宽](intl.zh-CN/用户指南/监听/共享实例带宽.md#)。

|
|**调度算法**|负载均衡支持轮询、加权轮询（WRR）、加权最小连接数（WLC）三种调度算法。-   轮询：按照访问顺序依次将外部请求依序分发到后端服务器。
-   加权轮询：权重值越高的后端服务器，被轮询到的次数（概率）也越高。
-   加权最小连接数：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。

|
|**使用服务器组**|选择是否使用服务器组。使用服务器组，可以在监听维度上个性化定义服务器组，即实例下的不同监听可使用不同的服务器组。**说明：** 使用服务器组后，该监听会将流量转发到选择的服务器组，实例维度的后端服务器不再生效。如果不开启服务器组，监听会将流量转发到后端服务器池内添加的服务器上。详情参考[添加后端服务器](intl.zh-CN/用户指南/后端服务器/添加默认服务器.md#)。

|
|**服务器组类型**|如果选择使用服务器组，选择您要使用的服务器组类型：-   虚拟服务器组：一个虚拟服务器组（VServer group）由多个后端服务器组成，且后端服务器的端口可以不同。您可以为不同的监听配置不同的虚拟服务器组，这样就可以将请求转发至不同的后端服务器。详情参考[创建虚拟服务器组](intl.zh-CN/用户指南/后端服务器/创建虚拟服务器组.md#)。
-   主备服务器组：一个主备服务器组由两台后端服务器组成，即一台主服务器，一台备服务器。当您有传统的主备需求时，可以使用主备服务器组。当主机工作正常时，将流量转发至主服务器；当主机宕机时，会将流量转发至备服务器，避免服务中断。详情参考[创建主备服务器组](intl.zh-CN/用户指南/后端服务器/创建主备服务器组.md#)。

|
|**创建完毕自动启动监听**|是否在监听配置完成后启动负载均衡监听，默认开启。|
|高级配置|
|**获取真实IP**|针对四层监听，后端服务器可直接获得来访者的真实IP，无需采用其它手段获取。**说明：** 经典网络的负载均衡实例的UDP监听暂不支持查看源地址。

|
|**会话保持**|是否开启会话保持。开启会话保持后，负载均衡监听会把来自同一客户端的访问请求分发到同一台后端服务器上。针对TCP监听，负载均衡是基于IP地址的会话保持，即来自同一IP地址的访问请求转发到同一台后端服务器上。

**说明：** UDP监听不支持会话保持。

|
|**连接超时时间**|指定TCP连接的超时时间，范围10-900秒。|
|**启用访问控制**|选择是否启用访问控制。|
|**访问控制方式**| 开启访问控制后，选择一种访问控制方式：

 -   白名单：仅转发来自所选访问控制策略组中设置的IP地址或地址段的请求，白名单适用于应用只允许特定IP访问的场景。

设置白名单存在一定业务风险。一旦设置白名单，就只有白名单中的IP可以访问负载均衡监听。如果开启了白名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。

-   黑名单：来自所选访问控制策略组中设置的IP地址或地址段的所有请求都不会转发，黑名单适用于应用只限制某些特定IP访问的场景。

如果开启了黑名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。


 |
|**访问控制策略组**|选择访问控制策略组，作为该监听的白名单或黑名单。详情参见[访问控制策略组](intl.zh-CN/用户指南/访问控制/配置访问控制策略组.md#)。|

