# 添加TCP监听 {#task_qdy_bhm_42b .task}

TCP协议适用于注重可靠性，对数据准确性要求高，速度可以相对较慢的场景，如文件传输、发送或接收邮件、远程登录等。您可以添加一个TCP监听转发来自TCP协议的请求。

[创建负载均衡实例](cn.zh-CN/用户指南（新版控制台）/负载均衡实例/创建负载均衡实例.md#)

1.  登录[负载均衡管理控制台](https://slb.console.aliyun.com)。 
2.  在左侧导航栏，单击**实例** \> **实例管理**。 
3.  选择实例的地域。 
4.  选择以下一种方法，打开监听配置向导： 
    -   在实例管理页面，找到目标实例，然后单击**添加配置向导**。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7398_zh-CN.png)

    -   在实例管理页面，单击目标实例ID。在监听页面，单击**添加监听**。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7399_zh-CN.png)

5.  配置监听协议。 根据以下信息，配置TCP监听。

    |监听配置|说明|
    |:---|:-|
    |**监听协议**|选择监听的协议类型。|
    |**监听端口**|用来接收请求并向后端服务器进行请求转发的监听端口。端口范围为1-65535。

**说明：** 在同一个负载均衡实例内，监听端口不可重复。

|
    |**调度算法**|负载均衡支持轮询、加权轮询（WRR）、加权最小连接数（WLC）三种调度算法。    -   **加权轮询**：权重值越高的后端服务器，被轮询到的次数（概率）也越高。
    -   **轮询**：按照访问顺序依次将外部请求依序分发到后端服务器。
    -   **加权最小连接数**：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。
|
    |**高级配置**|
    |**会话保持**|是否开启会话保持。开启会话保持后，负载均衡监听会把来自同一客户端的访问请求分发到同一台后端服务器上。

TCP协议是基于IP地址的会话保持，即来自同一IP地址的访问请求转发到同一台后端服务器上。

|
    |**启用访问控制**|选择是否启用访问控制。|
    |**访问控制方式**| 开启访问控制后，选择一种访问控制方式：

     -   **白名单**：仅转发来自所选访问控制策略组中设置的IP地址或地址段的请求，白名单适用于应用只允许特定IP访问的场景。

设置白名单存在一定业务风险。一旦设置白名单，就只有白名单中的IP可以访问负载均衡监听。如果开启了白名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。

    -   **黑名单**：来自所选访问控制策略组中设置的IP地址或地址段的所有请求都不会转发，黑名单适用于应用只限制某些特定IP访问的场景。

如果开启了黑名单访问，但访问策略组中没有添加任何IP，则负载均衡监听会转发全部请求。

 |
    |**选择访问控制策略组**|选择访问控制策略组，作为该监听的白名单或黑名单。**说明：** IPv6实例只能绑定IPv6访问控制策略组，IPv4实例只能绑定IPv4访问控制策略组。详情参见[访问控制策略组](cn.zh-CN/用户指南/访问控制/配置访问控制策略组.md#)。

|
    |**开启带宽峰值**| 选择是否配置监听带宽。

 对于按带宽计费的负载均衡实例，您可以针对不同监听设定不同的带宽峰值来限定监听的流量。实例下所有监听的带宽峰值总和不能超过该实例的带宽。

 默认不开启，各监听共享实例的总带宽。

 **说明：** 使用流量计费方式的实例默认不限制带宽峰值。

 |
    |**连接超时时间**|指定TCP连接的超时时间，范围10-900秒。|
    |**获取真实IP**|针对四层监听，后端服务器可直接获得来访者的真实IP，无需采用其它手段获取。|
    |**创建完毕自动启动监听**|是否在监听配置完成后启动负载均衡监听，默认开启。|

6.  单击**下一步**配置后端服务器。 

    您可以使用实例配置的默认服务器组，也可以为监听配置一个虚拟服务器组或主备服务组。详情参见[后端服务器概述](cn.zh-CN/用户指南（新版控制台）/后端服务器/后端服务器概述.md#)。

    本操作中，以默认后端服务器组为例：

    1.  选择**默认服务器组**，单击**添加**。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7407_zh-CN.png)

    2.  选择要添加的ECS实例，然后单击**加入待添加篮子**。单击**确定**。 

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7414_zh-CN.png)

    3.  配置添加的后端服务器的端口和权重。 
        -   端口

            后端服务器（ECS实例）开放用来接收请求的端口，端口范围为1-65535。同一个负载均衡实例内，后端服务器端口可以相同。

        -   权重

            后端服务器（ECS实例）的权重。权重越高的ECS实例将被分配到更多的访问请求。

            **说明：** 权重设置为0，该服务器不会再接受新请求。

    4.  单击**下一步**。 
7.  配置健康检查，然后单击**下一步**。 负载均衡通过健康检查来判断后端服务器（ECS实例）的业务可用性。健康检查机制提高了前端业务整体可用性，避免了后端ECS异常对总体服务的影响。单击**修改**更改健康检查配置，详情参见[配置健康检查](cn.zh-CN/用户指南（新版控制台）/健康检查/配置健康检查.md#)。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7416_zh-CN.png)

8.  检查监听配置，您可以单击**修改**更改配置。确认无误后，单击**提交**。 
9.  在配置审核页面，在配置成功后，单击**确定**。 

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7417_zh-CN.png)


配置成功后，您可以在监听页面查看已创建的监听。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/16161/7418_zh-CN.png)

[设置访问控制](cn.zh-CN/用户指南（新版控制台）/访问控制/设置访问控制.md#)

